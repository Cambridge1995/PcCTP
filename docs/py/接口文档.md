
# PyMdSpi

## 1. `on_front_connected`*

CTP接口原型(C++)：

参数：

返回值：

调用示例：

FAQ：

## 2. `on_front_disconnected`*

CTP接口原型(C++)：

参数：

返回值：

调用示例：

FAQ：

## 3. `on_rsp_user_login`*

CTP接口原型(C++)：

参数：

返回值：

调用示例：

FAQ：

## 4. `on_rsp_error`*

CTP接口原型(C++)：

参数：

返回值：

调用示例：

FAQ：

## 5. `on_rsp_sub_market_data`*

CTP接口原型(C++)：

参数：

返回值：

调用示例：

FAQ：

## 6. `on_rsp_un_sub_market_data`*

CTP接口原型(C++)：

参数：

返回值：

调用示例：

FAQ：

## 7. `on_rtn_depth_market_data`

深度行情通知，当使用[subscribe_market_data](#8. subscribe_market_data)订阅行情后，行情通知由此推送。

1. CTP接口原型(C++)：

   ```C++
   virtual void OnRtnDepthMarketData(CThostFtdcDepthMarketDataField *pDepthMarketData) {};
   ```

2. 参数：

   **depth_market_data**：深度行情，事实上是切片快照，根据每个交易所的推送频率，有所不同，一般为一分钟两次。使用的是`DepthMarketData`类型，但本质是`dict`，使用`dict`同样的操作方式。

   ```python
   class DepthMarketData(TypedDict):
       """深度行情数据
   
       CTP 行情推送的完整深度行情数据，包含最新价格、成交量、五档买卖价等信息。
       注意：exchange_id 和 exchange_inst_id 字段在某些服务器上可能为空。
       """
       # ===== 字符串字段 =====
       instrument_id: str  # 合约代码
       exchange_id: str  # 交易所代码（可能为空）
       exchange_inst_id: str  # 合约在交易所的代码（可能为空）
       # ===== 时间相关 =====
       trading_day: str  # 交易日
       action_day: str  # 业务日期
       update_time: str  # 最后修改时间 (HH:MM:SS 格式)
   	update_millisec: int  # 最后修改毫秒
       # ===== 价格字段 =====
       last_price: float  # 最新价
       pre_settlement_price: float  # 昨结算价
       pre_close_price: float  # 昨收盘价
       pre_open_interest: float  # 昨持仓量
       open_price: float  # 今开盘价
       highest_price: float  # 最高价
       lowest_price: float  # 最低价
       close_price: float  # 今收盘价
       settlement_price: float  # 今结算价
       upper_limit_price: float  # 涨停板价
       lower_limit_price: float  # 跌停板价
       pre_delta: float  # 昨日Delta值(期权相关)
       curr_delta: float  # 今日Delta值(期权相关)
       average_price: float  # 当日均价
   
       # ===== 成交量字段 =====
       volume: int  # 成交量
       turnover: float  # 成交金额
       open_interest: float  # 持仓量
       
   
       # ===== 五档买卖价 =====
       # 买档
       bid_price1: float  # 买一价
       bid_volume1: int  # 买一量
       bid_price2: float  # 买二价
       bid_volume2: int  # 买二量
       bid_price3: float  # 买三价
       bid_volume3: int  # 买三量
       bid_price4: float  # 买四价
       bid_volume4: int  # 买四量
       bid_price5: float  # 买五价
       bid_volume5: int  # 买五量
       # 卖档
       ask_price1: float  # 卖一价
       ask_volume1: int  # 卖一量
       ask_price2: float  # 卖二价
       ask_volume2: int  # 卖二量
       ask_price3: float  # 卖三价
       ask_volume3: int  # 卖三量
       ask_price4: float  # 卖四价
       ask_volume4: int  # 卖四量
       ask_price5: float  # 卖五价
       ask_volume5: int  # 卖五量
   ```

3. FAQ：

   1. ***Q：*** *<u>行情中有些字段出现极大值，为什么？</u>*

      ***A：*** 行情通知中，例如结算价、收盘价、买卖价出现`double`极大值，则表示该字段没有值。例如涨停板的时候，因为没有卖价，会给出一个`double`极大值，同时卖量为`0`。

      

   2. ***Q：*** *<u>郑商所的结算价在盘中也会送出，但数值在盘中不会变化，这和盘后推送的结算价怎么区分？</u>*

      ***A：*** 郑商所夜盘收盘后会推送结算价，这也就是早上行情中有可能会收到结算价的原因，盘中行情中推送的结算价数值不会发生变化。无夜盘的合约，盘中不会收到结算价。白盘收盘后郑商所也会推送所有合约最新的结算价，CTP对交易所推送的结算价不做处理，直接转发。

      

   3. ***Q：*** *<u>郑商所的UDP行情里，`tradingday` 和 `average_price` 字段都是空的，但是TCP行情里有，这是为什么？</u>*

      ***A：*** UDP行情不推送 `average_price` 字段；TCP行情里的 `tradingday` 和 `average_price` 是CTP给的。

      

   4. ***Q：*** *<u>行情中哪些字段是CTP自己计算发出的？</u>*

      ***A：*** 郑商所的套利合约的涨跌停板价由CTP计算，交易所不发成交总额郑商所不推送由CTP计算，另外cffex,dce,shfe,ine这几家的成交均价不推送，由ctp计算。

      

   5. ***Q：*** *<u>发现连上前置后，为什么收到的行情涨跌停价是0？</u>*

      ***A：*** 连上的如果是mdfront的话可能mdfront是级联的，也就是说上一级还是mdfront这两个mdfront如果版本不对，也同样会导致这个问题。

      

   6. ***Q：*** *<u>订阅后大商所组合合约行情不跳动，其他交易终端（闪电王、快期等）的组合合约都有行情且在跳跃，为什么？</u>*

      ***A：*** 大商所只会推送单腿合约的行情，组合合约的行情需要下端自行计算。其他终端则是实时计算两条腿的价差，故行情看上去一直跳跃。

      

   7. ***Q：*** *<u>行情中为什么T日的 `open_interest` 和 T+1日的 `pre_open_interest`手数不一致？</u>*

      ***A：*** 交易所有大笔报单产生，大笔报单不是通过交易方式报出的。不在盘中行情中体现，盘中交易所会公示出来，盘后才汇总到行情中。

   

## 8. `on_rsp_user_logout`*

CTP接口原型(C++)：

参数：

返回值：

调用示例：

FAQ：

## 9. `on_heart_beat_warning`*

CTP接口原型(C++)：

参数：

返回值：

调用示例：

FAQ：

## 10. `on_rsp_sub_for_quote_rsp`*

CTP接口原型(C++)：

参数：

返回值：

调用示例：

FAQ：

## 11. `on_rsp_un_sub_for_quote_rsp`*

CTP接口原型(C++)：

参数：

返回值：

调用示例：

FAQ：

## 12. `on_rtn_for_quote_rsp`*

CTP接口原型(C++)：

参数：

返回值：

调用示例：

FAQ：

## 13. `on_rsp_qry_multicast_instrument`*

CTP接口原型(C++)：

参数：

返回值：

调用示例：

FAQ：

# MdApi

## 1. `create_ftdc_md_api`*

CTP接口原型(C++)：

参数：

返回值：

调用示例：

FAQ：

## 2. `get_api_version`*

CTP接口原型(C++)：

参数：

返回值：

调用示例：

FAQ：

## 3. `get_trading_day`*

CTP接口原型(C++)：

参数：

返回值：

调用示例：

FAQ：

## 4. `init`*

CTP接口原型(C++)：

参数：

返回值：

调用示例：

FAQ：

## 5. `join`*

CTP接口原型(C++)：

参数：

返回值：

调用示例：

FAQ：

## 6. `register_front`*

CTP接口原型(C++)：

参数：

返回值：

调用示例：

FAQ：

## 7. `register_spi`*

CTP接口原型(C++)：

参数：

返回值：

调用示例：

FAQ：

## 8. `subscribe_market_data`*

CTP接口原型(C++)：

参数：

返回值：

调用示例：

FAQ：

## 9. `un_subscribe_market_data`*

CTP接口原型(C++)：

参数：

返回值：

调用示例：

FAQ：

## 10. `req_user_login`*

CTP接口原型(C++)：

参数：

返回值：

调用示例：

FAQ：

## 11. `req_user_logout`

登出请求，对应响应[on_rsp_user_logout](#8. on_rsp_user_logout)。***暂不支持。***

   ```python
   req_user_logout(self, user_logout: UserLogout, request_id: int)
   ```

1. CTP接口原型(C++)：

   ```c++
   virtual int ReqUserLogout(CThostFtdcUserLogoutField *pUserLogout, int nRequestID) = 0;
   ```

2. 参数： 

   **user_logout**：使用的是`UserLogout`类型，但本质是`dict`，使用`dict`同样的操作方式。

   ```python
   class UserLogout(TypedDict):
       """用户登出请求
   
       用于向 CTP 系统发起登出请求。
       """
       broker_id: Required[str]  # 经纪公司代码，必需
       user_id: Required[str]  # 用户代码，必需
   ```

   若是出现弱提示，则进行类型限定，如下：

   ```python
   # 直接使用dict的构造方法
   logout = {
       'broker_id':'9999',
       'user_id':'12345'
   }
   # 如果在使用req_user_logout(logout,2)时，IDE出现弱提示，不用管，其本质就是dict，可正常运行，但有强迫症者，可以使用如下方式消除弱提示
   logout:UserLogout = {
       'broker_id':'9999',
       'user_id':'12345'
   }
   ```

   **request_id**：请求ID，对应响应里的`request_id`，无递增规则，由用户自行维护。

3. 返回值：

   0：代表成功。

   -1：表示网络连接失败；

   -2：表示未处理请求超过许可数；

   -3：表示每秒发送请求数超过许可数。

4. 调用示例：

   ```python
   logout:UserLogout = {
       'broker_id':'9999',
       'user_id':'12345'
   }
   request_id = 1
   result = mdapi.req_user_logout(self, user_logout, request_id)
   if result == 0:
   	print('登出请求发送成功。')
   elif result == -1:
   		print('网络连接失败。')
   elif result == -2:
   	print('未处理请求超过许可数。')
   elif result == -3:
   	print('每秒发送请求数超过许可数。')
   ```

5. FAQ：

   1. ***Q：*** *<u>发送后没有登出成功，反而通过`on_rsp_error()`返回错误信息，为什么？</u>*

      ***A：*** CTP文档显示此接口暂时不支持，截止于测试日2026年01月03日，经测试，调用后方法返回值返回 `0`，但会通过`on_rsp_error()`发送错误码为 `77` ，错误消息为 `CTP:无此功能` 。行情接口退出直接通过`release()`释放资源后,中断程序即可。

## 12. `release`*




## 13. `register_name_server`*


## 14. `register_fens_user_info`*



## 15. `subscribe_for_quote_rsp`*



## 16. `un_subscribe_for_quote_rsp`*



## 17. `req_qry_multicast_instrument`*
